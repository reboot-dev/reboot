syntax = "proto3";

// To build this proto with bazel, the proto and bazel rule must be in the same
// package, which means that the proto file must have a package declaration
// matching the Bazel workspace's folder structure.
package rbt.v1alpha1;

import "google/protobuf/descriptor.proto";

service PlacementPlanner {
  rpc ListenForPlan(ListenForPlanRequest)
      returns (stream ListenForPlanResponse);
}

message ListenForPlanRequest {}

message ListenForPlanResponse {
  Plan plan = 1;
  // TODO: drop the following field here. Instead, have a stand-alone service
  //       that tracks servers (and other things, like shards).
  repeated Server servers = 2;
}

message Plan {
  // This version must strictly increase from plan to plan.
  int64 version = 1;
  repeated Application applications = 2;

  message Application {
    string id = 1;
    repeated Service services = 2;
    repeated Shard shards = 3;  // Sorted by `range.first_key`.

    message Service {
      // The fully qualified name of the service.
      // E.g. "chat_room.v1.ChatRoomMethods".
      string full_name = 1;
      // The fully qualified name of the state hosting this service; E.g.
      // "chat_room.v1.ChatRoom". May be empty if the service is a
      // legacy gRPC service.
      string state_type_full_name = 2;
    }

    message Shard {
      string id = 1;
      KeyRange range = 2;
      string server_id = 3;
      uint32 replica_index = 4;

      message KeyRange {
        bytes first_key = 1;  // Inclusive.
        // The range is considered to end at the last key before the `first_key`
        // of the next shard in the list, or at the end of the key space if this
        // is the last shard.
      }
    }
  }
}

message Server {
  // E.g. "c1234". Matches `ShardAssignment.server_id`.
  string id = 1;

  string application_id = 5;
  uint32 revision_number = 7;

  // The routable address for this server.
  Address address = 2;

  // The kubernetes namespace in which the server lives. Unused if not on
  // kubernetes.
  string namespace = 4;

  // TODO: consider consolidating with Respect's NetworkAddress?
  message Address {
    // E.g. "c1234.mynamespace.svc.cluster.local", or "localhost".
    string host = 1;
    int32 port = 2;
  }

  // `FileDescriptorSet` for this server.
  google.protobuf.FileDescriptorSet file_descriptor_set = 6;

  // The version of Reboot running in this application. This is used
  // by the controller to determine what features are supported by the
  // application.
  string reboot_version = 8;
}

message ReplicaConfig {
  message Replica {
    // The routable address (i.e. including a port) of the replica.
    Server.Address address = 1;
  }
  // The list of replicas hosting this application. The replica's index
  // in the list is its `replica_index`.
  repeated Replica replicas = 1;
}
